{% extends 'base.html.twig' %}

{% block body %}
    <h1>Placez vos navires !</h1>

    <div class="container">
        <div class="playerpanel">
            <div class="ship-table">
                <div class="ship-container">
                    <img id="carrier" src="{{ asset('uploads/images/posters/carrierSide.svg') }}" alt="Carrier" class="ship" data-type="carrier">
                </div>
                <div class="ship-container">
                    <img id="battleship" src="{{ asset('uploads/images/posters/battleshipSide.svg') }}" alt="Battleship" class="ship" data-type="battleship">
                </div>
                <div class="ship-container">
                    <img id="cruiser" src="{{ asset('uploads/images/posters/cruiserSide.svg') }}" alt="Cruiser" class="ship" data-type="cruiser">
                </div>
                <div class="ship-container">
                    <img id="submarine" src="{{ asset('uploads/images/posters/submarineSide.svg') }}" alt="Submarine" class="ship" data-type="submarine">
                </div>
                <div class="ship-container">
                    <img id="destroyer" src="{{ asset('uploads/images/posters/destroyerSide.svg') }}" alt="Destroyer" class="ship" data-type="destroyer">
                </div>
                <button class="orientation-toggle">Changer l'orientation</button>
            </div>

            <div>
                <h2>Votre flotte</h2>
                <div class="board" style="background-image: url('{{ asset('uploads/images/posters/BoardBackground.png') }}')">
                    {% for tile in playerBoard.tiles %}
                        <div class="tile tile{{ tile.status }}" data-x="{{ tile.x }}" data-y="{{ tile.y }}">
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let selectedShip = null;

            function toggleOrientation() {
                if (selectedShip) {
                    const x = parseInt(selectedShip.getAttribute('data-x'));
                    const y = parseInt(selectedShip.getAttribute('data-y'));
                    const size = getSizeByShipType(selectedShip.getAttribute('data-type'));
                    const isVertical = selectedShip.getAttribute('data-orientation') === 'V';
                    const newOrientation = isVertical ? 'H' : 'V';

                    // Vérifier la disponibilité des cases pour la nouvelle orientation
                    let validPlacement = true;
                    if (newOrientation === 'H') {
                        if (y + size > 11) validPlacement = false;
                        else {
                            for (let i = y; i < y + size; i++) {
                                const tile = document.querySelector(`.tile[data-x="${x}"][data-y="${i}"]`);
                                if (tile && tile.classList.contains('full') && tile !== selectedShip.parentElement) {
                                    validPlacement = false;
                                    break;
                                }
                            }
                        }
                    } else {
                        if (x + size > 11) validPlacement = false;
                        else {
                            for (let i = x; i < x + size; i++) {
                                const tile = document.querySelector(`.tile[data-x="${i}"][data-y="${y}"]`);
                                if (tile && tile.classList.contains('full') && tile !== selectedShip.parentElement) {
                                    validPlacement = false;
                                    break;
                                }
                            }
                        }
                    }

                    if (!validPlacement) {
                        alert('Invalid placement!');
                        return;
                    }

                    // Marquer les cases comme vides pour l'ancienne orientation
                    markTilesEmpty(x, y, size, isVertical);

                    // Appliquer la nouvelle orientation
                    selectedShip.setAttribute('data-orientation', newOrientation);

                    // Marquer les cases selon la nouvelle orientation
                    markTiles(x, y, size, newOrientation === 'V');

                    // Ajouter ou supprimer la classe 'vertical' à la tuile originale
                    const originalTile = document.querySelector(`.tile[data-x="${x}"][data-y="${y}"]`);
                    if (newOrientation === 'V') {
                        originalTile.classList.add('vertical');
                    } else {
                        originalTile.classList.remove('vertical');
                    }
                }
            }

            function getSizeByShipType(shipType) {
                switch (shipType) {
                    case 'carrier': return 5;
                    case 'battleship': return 4;
                    case 'cruiser': return 3;
                    case 'submarine': return 3;
                    case 'destroyer': return 2;
                    default: return 0;
                }
            }

            document.querySelectorAll('.ship').forEach(ship => {
                ship.addEventListener('click', function() {
                    if (selectedShip) {
                        selectedShip.classList.remove('selected');
                        clearTileHighlights();
                    }
                    selectedShip = ship;
                    ship.classList.add('selected');
                    highlightTiles(ship);
                });
            });

            document.querySelectorAll('.tile').forEach(tile => {
                tile.addEventListener('click', function() {
                    if (selectedShip && !tile.classList.contains('full')) {
                        const shipType = selectedShip.getAttribute('data-type');
                        const x = parseInt(tile.getAttribute('data-x'));
                        const y = parseInt(tile.getAttribute('data-y'));
                        const size = getSizeByShipType(shipType);
                        let orientation = selectedShip.getAttribute('data-orientation') || 'H';

                        let validPlacement = true;
                        if (orientation === 'H') {
                            if (y + size > 11) validPlacement = false;
                            else {
                                for (let i = y; i < y + size; i++) {
                                    const tile = document.querySelector(`.tile[data-x="${x}"][data-y="${i}"]`);
                                    if (tile.classList.contains('full')) {
                                        validPlacement = false;
                                        break;
                                    }
                                }
                            }
                        } else {
                            if (x + size > 11) validPlacement = false;
                            else {
                                for (let i = x; i < x + size; i++) {
                                    const tile = document.querySelector(`.tile[data-x="${i}"][data-y="${y}"]`);
                                    if (tile.classList.contains('full')) {
                                        validPlacement = false;
                                        break;
                                    }
                                }
                            }
                        }

                        if (!validPlacement) {
                            alert('Invalid placement!');
                            return;
                        }

                        // Supprimer l'image précédente du navire s'il en existe une
                        const previousImg = document.querySelector(`.tile img[data-type="${shipType}"]`);
                        if (previousImg) {
                            const prevX = parseInt(previousImg.getAttribute('data-x'));
                            const prevY = parseInt(previousImg.getAttribute('data-y'));
                            const prevOrientation = previousImg.getAttribute('data-orientation') || 'H';
                            const prevSize = getSizeByShipType(shipType);
                            markTilesEmpty(prevX, prevY, prevSize, prevOrientation === 'V');
                            previousImg.parentElement.innerHTML = ''; // Supprimer l'image du navire
                        }

                        markTiles(x, y, size, orientation === 'V');

                        const shipImg = document.createElement('img');
                        shipImg.src = `/uploads/images/posters/${shipType}Up.svg`;
                        shipImg.alt = shipType;
                        shipImg.classList.add(shipType.toLowerCase());
                        shipImg.setAttribute('data-type', shipType);
                        shipImg.setAttribute('data-x', x);
                        shipImg.setAttribute('data-y', y);
                        shipImg.setAttribute('data-orientation', orientation);

                        tile.innerHTML = '';
                        tile.appendChild(shipImg);
                        tile.classList.add('full');

                        // Supprimer l'image du navire du panneau
                        const shipPanelImg = document.querySelector(`#${shipType}`);
                        if (shipPanelImg) {
                            shipPanelImg.remove();
                        }

                        selectedShip.classList.remove('selected');
                        selectedShip = null;
                        clearTileHighlights();
                    }
                });
            });

            document.querySelectorAll('.tile').forEach(tile => {
                tile.addEventListener('click', function() {
                    if (tile.classList.contains('full')) {
                        const placedShip = tile.querySelector('img');
                        if (selectedShip) {
                            selectedShip.classList.remove('selected');
                            clearTileHighlights();
                        }
                        selectedShip = placedShip;
                        placedShip.classList.add('selected');
                        highlightTiles(selectedShip);
                    }
                });
            });

            function markTiles(startX, startY, size, isVertical) {
                if (isVertical) {
                    for (let i = startX; i < startX + size; i++) {
                        const tile = document.querySelector(`.tile[data-x="${i}"][data-y="${startY}"]`);
                        tile.classList.add('full');
                    }
                } else {
                    for (let i = startY; i < startY + size; i++) {
                        const tile = document.querySelector(`.tile[data-x="${startX}"][data-y="${i}"]`);
                        tile.classList.add('full');
                    }
                }
            }

            function markTilesEmpty(startX, startY, size, isVertical) {
                if (isVertical) {
                    for (let i = startX; i < startX + size; i++) {
                        const tile = document.querySelector(`.tile[data-x="${i}"][data-y="${startY}"]`);
                        tile.classList.remove('full');
                    }
                } else {
                    for (let i = startY; i < startY + size; i++) {
                        const tile = document.querySelector(`.tile[data-x="${startX}"][data-y="${i}"]`);
                        tile.classList.remove('full');
                    }
                }
            }

            function highlightTiles(ship) {
                const shipType = ship.getAttribute('data-type');
                const x = parseInt(ship.getAttribute('data-x'));
                const y = parseInt(ship.getAttribute('data-y'));
                const size = getSizeByShipType(shipType);
                const orientation = ship.getAttribute('data-orientation');

                clearTileHighlights();

                if (orientation === 'H') {
                    for (let i = y; i < y + size; i++) {
                        const tile = document.querySelector(`.tile[data-x="${x}"][data-y="${i}"]`);
                        tile.classList.add('selected');
                    }
                } else {
                    for (let i = x; i < x + size; i++) {
                        const tile = document.querySelector(`.tile[data-x="${i}"][data-y="${y}"]`);
                        tile.classList.add('selected');
                    }
                }
            }

            function clearTileHighlights() {
                document.querySelectorAll('.tile.selected').forEach(tile => {
                    tile.classList.remove('selected');
                });
            }

            document.querySelector('.orientation-toggle').addEventListener('click', function() {
                toggleOrientation();
            });
        });
    </script>
{% endblock %}