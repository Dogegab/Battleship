{% extends 'base.html.twig' %}

{% block body %}
    <h1>Placez vos navires !</h1>

    <div class="container">
        <div class="playerpanel">
            <div class="ship-table">
                <div class="ship-container">
                    <img src="{{ asset('uploads/images/posters/carrierSide.svg') }}" alt="Carrier" class="ship" data-type="carrier">
                </div>
                <div class="ship-container">
                    <img src="{{ asset('uploads/images/posters/battleshipSide.svg') }}" alt="Battleship" class="ship" data-type="battleship">
                </div>
                <div class="ship-container">
                    <img src="{{ asset('uploads/images/posters/cruiserSide.svg') }}" alt="Cruiser" class="ship" data-type="cruiser">
                </div>
                <div class="ship-container">
                    <img src="{{ asset('uploads/images/posters/submarineSide.svg') }}" alt="Submarine" class="ship" data-type="submarine">
                </div>
                <div class="ship-container">
                    <img src="{{ asset('uploads/images/posters/destroyerSide.svg') }}" alt="Destroyer" class="ship" data-type="destroyer">
                </div>
                <button class="orientation-toggle">Changer l'inclinaison d'un navire sélectionné</button>
            </div>

            <div>
                <h2>Votre flotte</h2>
                <div class="board" style="background-image: url('{{ asset('uploads/images/posters/BoardBackground.png') }}')">
                    {% for tile in playerBoard.tiles %}
                        <div class="tile {% if tile.status == 'full' %}full{% endif %}" data-x="{{ tile.x }}" data-y="{{ tile.y }}">
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let selectedShip = null;

    function toggleOrientation() {
        if (selectedShip) {
            const parentTile = selectedShip.parentElement;
            const shipType = selectedShip.getAttribute('data-type');
            const x = parseInt(selectedShip.getAttribute('data-x'));
            const y = parseInt(selectedShip.getAttribute('data-y'));
            const size = getSizeByShipType(shipType);

            // Récupérer l'orientation actuelle du navire
            const isVertical = parentTile.classList.contains('vertical');

            // Marquer les cases comme vide pour l'ancienne orientation
            markTilesEmpty(shipType, x, y, size, isVertical);

            // Inverser l'orientation du navire
            parentTile.classList.toggle('vertical');

            // Mettre à jour l'attribut 'data-orientation'
            selectedShip.setAttribute('data-orientation', parentTile.classList.contains('vertical') ? 'V' : 'H');

            // Mettre à jour l'état des tuiles en fonction de la nouvelle orientation
            markTiles(shipType, x, y, size, !isVertical);
        }
    }

    function getSizeByShipType(shipType) {
        switch (shipType) {
            case 'carrier':
                return 5;
            case 'battleship':
                return 4;
            case 'cruiser':
                return 3;
            case 'submarine':
                return 3;
            case 'destroyer':
                return 2;
            default:
                return 0;
        }
    }

    // Événement pour sélectionner un navire dans le panneau des navires
    document.querySelectorAll('.ship').forEach(ship => {
        ship.addEventListener('click', function() {
            if (selectedShip) {
                selectedShip.classList.remove('selected');
                clearTileHighlights();
            }
            selectedShip = ship;
            ship.classList.add('selected');
            highlightTiles(selectedShip);
        });
    });

    // Événement pour placer un navire sur la grille du joueur
    document.querySelectorAll('.tile').forEach(tile => {
        tile.addEventListener('click', function() {
            if (selectedShip && !tile.classList.contains('full')) {
                const shipType = selectedShip.getAttribute('data-type');
                const x = parseInt(tile.getAttribute('data-x'));
                const y = parseInt(tile.getAttribute('data-y'));
                const size = getSizeByShipType(shipType);
                let orientation = selectedShip.getAttribute('data-orientation');

                // Si l'orientation n'est pas définie, la définir comme horizontale par défaut
                if (!orientation) {
                    orientation = 'H';
                    selectedShip.setAttribute('data-orientation', orientation);
                }

                let validPlacement = true;
                if (orientation === 'H') {
                    if (y + size > 10) {
                        validPlacement = false;
                    } else {
                        for (let i = y; i < y + size; i++) {
                            const tile = document.querySelector(`.tile[data-x="${x}"][data-y="${i}"]`);
                            if (tile.classList.contains('full') || tile.querySelector('img')) {
                                validPlacement = false;
                                break;
                            }
                        }
                    }
                } else { // Orientation 'V'
                    if (x + size > 10) {
                        validPlacement = false;
                    } else {
                        for (let i = x; i < x + size; i++) {
                            const tile = document.querySelector(`.tile[data-x="${i}"][data-y="${y}"]`);
                            if (tile.classList.contains('full') || tile.querySelector('img')) {
                                validPlacement = false;
                                break;
                            }
                        }
                    }
                }

                if (!validPlacement) {
                    alert('Le navire dépasse du plateau ou chevauche un autre navire ! Sélectionnez une autre case.');
                    return;
                }

                // Marquer les cases selon l'orientation choisie
                markTiles(shipType, x, y, size, orientation);

                // Créer l'élément img du navire et le placer sur la case
                const shipImg = document.createElement('img');
                shipImg.src = `/uploads/images/posters/${shipType}Up.svg`;
                shipImg.alt = shipType;
                shipImg.classList.add(shipType.toLowerCase());
                shipImg.setAttribute('data-type', shipType);
                shipImg.setAttribute('data-x', x);
                shipImg.setAttribute('data-y', y);
                shipImg.setAttribute('data-orientation', orientation);

                tile.innerHTML = '';
                tile.appendChild(shipImg);
                tile.classList.add('full');

                // Réinitialiser la sélection du navire et les mises en évidence des cases
                selectedShip.remove();
                selectedShip = null;
                clearTileHighlights();
            }
        });
    });

    // Sélection d'un navire déjà placé sur la carte
    document.querySelectorAll('.tile').forEach(tile => {
        tile.addEventListener('click', function() {
            if (tile.classList.contains('full')) {
                const placedShip = tile.querySelector('img');
                if (selectedShip) {
                    selectedShip.classList.remove('selected');
                    clearTileHighlights();
                }
                selectedShip = placedShip;
                placedShip.classList.add('selected');
                highlightTiles(selectedShip);
            }
        });
    });

    function markTiles(shipType, startX, startY, size, isVertical) {
        if (isVertical) {
            for (let i = startX; i < startX + size; i++) {
                const tile = document.querySelector(`.tile[data-x="${i}"][data-y="${startY}"]`);
                tile.classList.add('full');
            }
        } else { // Orientation horizontale (par défaut 'H')
            for (let i = startY; i < startY + size; i++) {
                const tile = document.querySelector(`.tile[data-x="${startX}"][data-y="${i}"]`);
                tile.classList.add('full');
            }
        }
    }

    function markTilesEmpty(shipType, startX, startY, size, isVertical) {
        if (isVertical) {
            for (let i = startX; i < startX + size; i++) {
                const tile = document.querySelector(`.tile[data-x="${i}"][data-y="${startY}"]`);
                tile.classList.remove('full');
            }
        } else { // Orientation horizontale (par défaut 'H')
            for (let i = startY; i < startY + size; i++) {
                const tile = document.querySelector(`.tile[data-x="${startX}"][data-y="${i}"]`);
                tile.classList.remove('full');
            }
        }
    }

    function highlightTiles(ship) {
        const shipType = ship.getAttribute('data-type');
        const x = parseInt(ship.getAttribute('data-x'));
        const y = parseInt(ship.getAttribute('data-y'));
        const size = getSizeByShipType(shipType);
        const orientation = ship.getAttribute('data-orientation');

        clearTileHighlights();

        if (orientation === 'H') {
            for (let i = y; i < y + size; i++) {
                const tile = document.querySelector(`.tile[data-x="${x}"][data-y="${i}"]`);
                tile.classList.add('selected');
            }
        } else { // Orientation 'V'
            for (let i = x; i < x + size; i++) {
                const tile = document.querySelector(`.tile[data-x="${i}"][data-y="${y}"]`);
                tile.classList.add('selected');
            }
        }
    }

    function clearTileHighlights() {
        document.querySelectorAll('.tile.selected').forEach(tile => {
            tile.classList.remove('selected');
        });
    }

    document.querySelector('.orientation-toggle').addEventListener('click', function() {
        toggleOrientation();
    });
});
</script>

{% endblock %}